{% extends 'askme/base.html' %}
{% load crispy_forms_tags %}

{% block askme_title %}{{ conversation.title }}{% endblock %}

{% block askme_content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Conversation with {{ conversation.llm_model.name }}</h5>
        <div>
            <a href="{% url 'askme:home' %}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle me-1"></i> New Conversation
            </a>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="conversation-container">
            {% for question in questions %}
            <div class="message-group">
                <div class="message user-message">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">You</span>
                            <span class="message-time">{{ question.created_at|date:"M d, g:i A" }}</span>
                        </div>
                        <div class="message-body">
                            {{ question.content|linebreaksbr }}
                            {% if question.file %}
                            <div class="mt-2">
                                <a href="{{ question.file.url }}" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-paperclip me-1"></i> {{ question.file.name|slice:"9:" }}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="message assistant-message">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">{{ conversation.llm_model.name }}</span>
                            {% if question.status != 'completed' %}
                            <span class="status-{{ question.status }}">
                                <i class="bi bi-{% if question.status == 'pending' %}hourglass-top{% elif question.status == 'processing' %}gear-fill spin{% elif question.status == 'failed' %}exclamation-triangle-fill{% endif %}"></i>
                                {{ question.get_status_display }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="message-body" id="response-{{ question.id }}">
                            {% if question.status == 'completed' and question.response %}
                                {{ question.response.content|linebreaksbr }}
                            {% elif question.status == 'processing' %}
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Processing...</span>
                                    </div>
                                    <span>Thinking...</span>
                                </div>
                            {% elif question.status == 'pending' %}
                                <div class="text-center py-3">
                                    <i class="bi bi-hourglass-top text-muted me-2"></i>
                                    <span>Waiting to process...</span>
                                </div>
                            {% elif question.status == 'failed' %}
                                <div class="text-danger">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    {{ question.error_message|default:"An error occurred while processing your question." }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="card-footer">
    <form method="post" id="followup-form" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Text field for follow-up question -->
        <div class="mb-3">
            <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
            {{ form.content }}
            {% if form.content.errors %}
            <div class="invalid-feedback d-block">
                {{ form.content.errors }}
            </div>
            {% endif %}
        </div>
        
        <!-- File upload field -->
        <div class="mb-3">
            <label for="{{ form.file.id_for_label }}" class="form-label">{{ form.file.label }}</label>
            {{ form.file }}
            {% if form.file.errors %}
            <div class="invalid-feedback d-block">
                {{ form.file.errors }}
            </div>
            {% else %}
            <div class="form-text small">
                Supported: TXT, PDF, DOCX, JPG, JPEG, PNG (max 10MB)
            </div>
            {% endif %}
        </div>
        
        <div class="d-grid mt-3">
            <button type="submit" class="btn btn-primary" id="submit-button">
                <i class="bi bi-send me-2"></i> Send
            </button>
        </div>
    </form>
</div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .conversation-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 1.5rem;
    }
    
    .message-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .message {
        display: flex;
        max-width: 100%;
    }
    
    .message-content {
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        width: 100%;
    }
    
    .user-message .message-content {
        background-color: #f0f7ff;
        border: 1px solid #cfe2ff;
    }
    
    .assistant-message .message-content {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .message-author {
        font-weight: bold;
    }
    
    .message-time {
        color: #6c757d;
    }
    
    .message-body {
        white-space: pre-wrap;
    }
    
    .spin {
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle form submission
        const form = document.getElementById('followup-form');
        const submitButton = document.getElementById('submit-button');
        
        if (form) {
            form.addEventListener('submit', function() {
                // Disable button and show loading state
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Sending...';
                submitButton.disabled = true;
            });
        }
        
        // Check status of processing questions
        const processingQuestions = document.querySelectorAll('[id^="response-"]');
        processingQuestions.forEach(element => {
            const questionId = element.id.split('-')[1];
            const parentMessage = element.closest('.message');
            const statusElement = parentMessage.querySelector('.status-processing, .status-pending');
            
            if (statusElement) {
                checkQuestionStatus(questionId);
            }
        });
        
        function checkQuestionStatus(questionId) {
            const responseElement = document.getElementById(`response-${questionId}`);
            const checkInterval = setInterval(() => {
                fetch(`/askme/questions/${questionId}/status/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            responseElement.innerHTML = data.response_content.replace(/\n/g, '<br>');
                            clearInterval(checkInterval);
                            // Reload to update header status
                            setTimeout(() => window.location.reload(), 500);
                        } else if (data.status === 'failed') {
                            responseElement.innerHTML = `<div class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>${data.error}</div>`;
                            clearInterval(checkInterval);
                            // Reload to update header status
                            setTimeout(() => window.location.reload(), 500);
                        }
                    })
                    .catch(error => console.error('Error checking status:', error));
            }, 3000);
        }
    });
</script>
{% endblock %}