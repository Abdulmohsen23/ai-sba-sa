{% extends 'program_ideation/base.html' %}
{% load ideation_tags %}

{% block ideation_title %}{{ title }}{% endblock %}

{% block ideation_content %}
<!-- Add CDN links for export functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    .completion-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 15px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    
    .completion-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .completion-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.2);
        padding: 10px 20px;
        border-radius: 30px;
        margin-bottom: 20px;
    }
    
    .completion-badge i {
        font-size: 24px;
        color: #4ade80;
    }
    
    .program-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .program-meta {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.15);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
    }
    
    .meta-item i {
        font-size: 16px;
    }
    
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .detail-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .detail-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .detail-card.name { border-left-color: #3b82f6; }
    .detail-card.idea { border-left-color: #10b981; }
    .detail-card.audience { border-left-color: #f59e0b; }
    .detail-card.objectives { border-left-color: #ef4444; }
    .detail-card.type { border-left-color: #8b5cf6; }
    .detail-card.duration { border-left-color: #ec4899; }
    .detail-card.episodes { border-left-color: #14b8a6; }
    .detail-card.location { border-left-color: #f97316; }
    
    .detail-label {
        font-size: 12px;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: 8px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .detail-content {
        color: #1f2937;
        font-size: 15px;
        line-height: 1.6;
    }
    
    .detail-icon {
        float: right;
        font-size: 24px;
        opacity: 0.2;
    }
    
    .nav-tabs {
        border: none;
        background: #f3f4f6;
        border-radius: 12px;
        padding: 5px;
        margin-bottom: 30px;
    }
    
    .nav-tabs .nav-link {
        border: none;
        background: transparent;
        color: #6b7280;
        padding: 12px 24px;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
        position: relative;
    }
    
    .nav-tabs .nav-link:hover {
        background: rgba(0,0,0,0.05);
    }
    
    .nav-tabs .nav-link.active {
        background: white;
        color: #1f2937;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .nav-tabs .nav-link i {
        margin-right: 8px;
    }
    
    .tab-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .response-section {
        position: relative;
    }
    
    .response-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f3f4f6;
    }
    
    .response-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .response-actions {
        display: flex;
        gap: 10px;
    }
    
    .btn-action {
        padding: 8px 16px;
        border: none;
        background: #f3f4f6;
        color: #6b7280;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    
    .btn-action:hover {
        background: #e5e7eb;
        color: #1f2937;
    }
    
    .btn-action i {
        margin-right: 6px;
    }
    
    .response-content {
        color: #374151;
        line-height: 1.8;
        font-size: 15px;
    }
    
    .response-content p {
        margin-bottom: 16px;
    }
    
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 13px;
        opacity: 0.9;
    }
    
    .export-section {
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
        text-align: center;
    }
    
    .export-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #1f2937;
    }
    
    .export-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-export {
        padding: 10px 24px;
        border: 2px solid;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-export.pdf {
        border-color: #dc2626;
        color: #dc2626;
    }
    
    .btn-export.pdf:hover {
        background: #dc2626;
        color: white;
    }
    
    .btn-export.word {
        border-color: #2563eb;
        color: #2563eb;
    }
    
    .btn-export.word:hover {
        background: #2563eb;
        color: white;
    }
    
    .btn-export.print {
        border-color: #16a34a;
        color: #16a34a;
    }
    
    .btn-export.print:hover {
        background: #16a34a;
        color: white;
    }
    
    .btn-export.share {
        border-color: #8b5cf6;
        color: #8b5cf6;
    }
    
    .btn-export.share:hover {
        background: #8b5cf6;
        color: white;
    }
    
    .floating-actions {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 1000;
    }
    
    .fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        color: #6b7280;
    }
    
    .fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .fab.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .progress-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
    }
    
    .progress-step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    
    .progress-step::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        right: -50%;
        height: 2px;
        background: #e5e7eb;
        z-index: -1;
    }
    
    .progress-step:last-child::before {
        display: none;
    }
    
    .progress-step.completed::before {
        background: #10b981;
    }
    
    .progress-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #6b7280;
    }
    
    .progress-step.completed .progress-circle {
        background: #10b981;
        color: white;
    }
    
    .progress-label {
        font-size: 13px;
        color: #6b7280;
    }
    
    @media print {
        .floating-actions,
        .export-section,
        .response-actions,
        .nav-tabs {
            display: none !important;
        }
        
        .tab-pane {
            display: block !important;
            page-break-after: always;
        }
    }
    
    /* RTL Support */
    [dir="rtl"] .detail-card {
        border-left: none;
        border-right: 4px solid;
    }
    
    [dir="rtl"] .detail-icon {
        float: left;
    }
    
    [dir="rtl"] .nav-tabs .nav-link i {
        margin-right: 0;
        margin-left: 8px;
    }
    
    [dir="rtl"] .floating-actions {
        right: auto;
        left: 30px;
    }
</style>

<div {% if idea.language == 'ar' %}dir="rtl"{% endif %}>
    <!-- Completion Header -->
    <div class="completion-header">
        <div class="completion-badge">
            <i class="bi bi-check-circle-fill"></i>
            <span>
                {% if idea.language == 'ar' %}
                اكتملت الفكرة
                {% else %}
                Idea Completed
                {% endif %}
            </span>
        </div>
        
        <h1 class="program-title">{{ idea.program_name|default:"Untitled Program" }}</h1>
        
        <div class="program-meta">
            <div class="meta-item">
                <i class="bi bi-tv"></i>
                <span>{{ idea.program_type|default:"Program Type" }}</span>
            </div>
            <div class="meta-item">
                <i class="bi bi-clock"></i>
                <span>{{ idea.program_duration|default:"Duration" }}</span>
            </div>
            <div class="meta-item">
                <i class="bi bi-collection-play"></i>
                <span>{{ idea.episode_count|default:"Episodes" }}</span>
            </div>
            <div class="meta-item">
                <i class="bi bi-calendar"></i>
                <span>{{ idea.created_at|date:"M d, Y" }}</span>
            </div>
        </div>
    </div>
    
    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-step completed">
            <div class="progress-circle">
                <i class="bi bi-check"></i>
            </div>
            <div class="progress-label">
                {% if idea.language == 'ar' %}
                البدء
                {% else %}
                Start
                {% endif %}
            </div>
        </div>
        <div class="progress-step completed">
            <div class="progress-circle">
                <i class="bi bi-check"></i>
            </div>
            <div class="progress-label">
                {% if idea.language == 'ar' %}
                التفاصيل
                {% else %}
                Details
                {% endif %}
            </div>
        </div>
        <div class="progress-step completed">
            <div class="progress-circle">
                <i class="bi bi-check"></i>
            </div>
            <div class="progress-label">
                {% if idea.language == 'ar' %}
                التطوير
                {% else %}
                Development
                {% endif %}
            </div>
        </div>
        <div class="progress-step completed">
            <div class="progress-circle">
                <i class="bi bi-check"></i>
            </div>
            <div class="progress-label">
                {% if idea.language == 'ar' %}
                الإكمال
                {% else %}
                Complete
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-number">8</div>
            <div class="stat-label">
                {% if idea.language == 'ar' %}
                حقول مكتملة
                {% else %}
                Fields Completed
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ responses|length }}</div>
            <div class="stat-label">
                {% if idea.language == 'ar' %}
                وثائق منشأة
                {% else %}
                Documents Generated
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-number">100%</div>
            <div class="stat-label">
                {% if idea.language == 'ar' %}
                نسبة الإكمال
                {% else %}
                Completion Rate
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Program Details Grid -->
    <div class="details-grid">
        <div class="detail-card name">
            <i class="bi bi-tv detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}اسم البرنامج{% else %}Program Name{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.program_name|default:"—" }}
            </div>
        </div>
        
        <div class="detail-card idea">
            <i class="bi bi-lightbulb detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}الفكرة العامة{% else %}General Idea{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.general_idea|truncatewords:20|default:"—" }}
            </div>
        </div>
        
        <div class="detail-card audience">
            <i class="bi bi-people detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}الجمهور المستهدف{% else %}Target Audience{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.target_audience|truncatewords:20|default:"—" }}
            </div>
        </div>
        
        <div class="detail-card objectives">
            <i class="bi bi-bullseye detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}أهداف البرنامج{% else %}Program Objectives{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.program_objectives|truncatewords:20|default:"—" }}
            </div>
        </div>
        
        <div class="detail-card type">
            <i class="bi bi-tags detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}نوع البرنامج{% else %}Program Type{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.program_type|default:"—" }}
            </div>
        </div>
        
        <div class="detail-card duration">
            <i class="bi bi-clock detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}مدة البرنامج{% else %}Program Duration{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.program_duration|default:"—" }}
            </div>
        </div>
        
        <div class="detail-card episodes">
            <i class="bi bi-collection-play detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}عدد الحلقات{% else %}Episode Count{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.episode_count|default:"—" }}
            </div>
        </div>
        
        <div class="detail-card location">
            <i class="bi bi-geo-alt detail-icon"></i>
            <div class="detail-label">
                {% if idea.language == 'ar' %}موقع التصوير{% else %}Filming Location{% endif %}
            </div>
            <div class="detail-content">
                {{ idea.filming_location|truncatewords:20|default:"—" }}
            </div>
        </div>
    </div>
    
    <!-- Tabbed Content -->
    <ul class="nav nav-tabs" id="contentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab">
                <i class="bi bi-question-circle"></i>
                {{ sections.discussion_questions|default:"Discussion Questions" }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="format-tab" data-bs-toggle="tab" data-bs-target="#format" type="button" role="tab">
                <i class="bi bi-layout-text-window"></i>
                {{ sections.program_format|default:"Program Format" }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="script-tab" data-bs-toggle="tab" data-bs-target="#script" type="button" role="tab">
                <i class="bi bi-file-text"></i>
                {{ sections.program_script|default:"Program Script" }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual" type="button" role="tab">
                <i class="bi bi-palette"></i>
                {{ sections.visual_materials|default:"Visual Materials" }}
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="contentTabsContent">
        <!-- Discussion Questions Tab -->
        <div class="tab-pane fade show active" id="questions" role="tabpanel">
            <div class="response-section">
                <div class="response-header">
                    <h2 class="response-title">
                        {{ sections.discussion_questions|default:"Discussion Questions" }}
                    </h2>
                    <div class="response-actions">
                        <button class="btn-action" onclick="copyContent('questions')">
                            <i class="bi bi-clipboard"></i>
                            {% if idea.language == 'ar' %}نسخ{% else %}Copy{% endif %}
                        </button>
                        <button class="btn-action" onclick="expandSection('questions')">
                            <i class="bi bi-arrows-fullscreen"></i>
                            {% if idea.language == 'ar' %}توسيع{% else %}Expand{% endif %}
                        </button>
                    </div>
                </div>
                <div class="response-content" id="questions-content">
                    {% if responses.discussion_questions %}
                        {{ responses.discussion_questions.content|linebreaks }}
                    {% else %}
                        <p>{% if idea.language == 'ar' %}لا توجد بيانات{% else %}No data available{% endif %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Program Format Tab -->
        <div class="tab-pane fade" id="format" role="tabpanel">
            <div class="response-section">
                <div class="response-header">
                    <h2 class="response-title">
                        {{ sections.program_format|default:"Program Format" }}
                    </h2>
                    <div class="response-actions">
                        <button class="btn-action" onclick="copyContent('format')">
                            <i class="bi bi-clipboard"></i>
                            {% if idea.language == 'ar' %}نسخ{% else %}Copy{% endif %}
                        </button>
                        <button class="btn-action" onclick="expandSection('format')">
                            <i class="bi bi-arrows-fullscreen"></i>
                            {% if idea.language == 'ar' %}توسيع{% else %}Expand{% endif %}
                        </button>
                    </div>
                </div>
                <div class="response-content" id="format-content">
                    {% if responses.program_format %}
                        {{ responses.program_format.content|linebreaks }}
                    {% else %}
                        <p>{% if idea.language == 'ar' %}لا توجد بيانات{% else %}No data available{% endif %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Program Script Tab -->
        <div class="tab-pane fade" id="script" role="tabpanel">
            <div class="response-section">
                <div class="response-header">
                    <h2 class="response-title">
                        {{ sections.program_script|default:"Program Script" }}
                    </h2>
                    <div class="response-actions">
                        <button class="btn-action" onclick="copyContent('script')">
                            <i class="bi bi-clipboard"></i>
                            {% if idea.language == 'ar' %}نسخ{% else %}Copy{% endif %}
                        </button>
                        <button class="btn-action" onclick="expandSection('script')">
                            <i class="bi bi-arrows-fullscreen"></i>
                            {% if idea.language == 'ar' %}توسيع{% else %}Expand{% endif %}
                        </button>
                    </div>
                </div>
                <div class="response-content" id="script-content">
                    {% if responses.program_script %}
                        {{ responses.program_script.content|linebreaks }}
                    {% else %}
                        <p>{% if idea.language == 'ar' %}لا توجد بيانات{% else %}No data available{% endif %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Visual Materials Tab -->
        <div class="tab-pane fade" id="visual" role="tabpanel">
            <div class="response-section">
                <div class="response-header">
                    <h2 class="response-title">
                        {{ sections.visual_materials|default:"Visual Materials" }}
                    </h2>
                    <div class="response-actions">
                        <button class="btn-action" onclick="copyContent('visual')">
                            <i class="bi bi-clipboard"></i>
                            {% if idea.language == 'ar' %}نسخ{% else %}Copy{% endif %}
                        </button>
                        <button class="btn-action" onclick="expandSection('visual')">
                            <i class="bi bi-arrows-fullscreen"></i>
                            {% if idea.language == 'ar' %}توسيع{% else %}Expand{% endif %}
                        </button>
                    </div>
                </div>
                <div class="response-content" id="visual-content">
                    {% if responses.visual_materials %}
                        {{ responses.visual_materials.content|linebreaks }}
                    {% else %}
                        <p>{% if idea.language == 'ar' %}لا توجد بيانات{% else %}No data available{% endif %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Section -->
    <div class="export-section">
        <h3 class="export-title">
            {% if idea.language == 'ar' %}
            تصدير ومشاركة المشروع
            {% else %}
            Export and Share Project
            {% endif %}
        </h3>
        <div class="export-buttons">
            <button class="btn-export pdf" onclick="exportToPDF()">
                <i class="bi bi-file-pdf"></i>
                {% if idea.language == 'ar' %}تصدير PDF{% else %}Export PDF{% endif %}
            </button>
            <button class="btn-export word" onclick="exportToWord()">
                <i class="bi bi-file-word"></i>
                {% if idea.language == 'ar' %}تصدير Word{% else %}Export Word{% endif %}
            </button>
            <button class="btn-export print" onclick="window.print()">
                <i class="bi bi-printer"></i>
                {% if idea.language == 'ar' %}طباعة{% else %}Print{% endif %}
            </button>
            <button class="btn-export share" onclick="shareProject()">
                <i class="bi bi-share"></i>
                {% if idea.language == 'ar' %}مشاركة{% else %}Share{% endif %}
            </button>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="d-flex justify-content-center gap-3 mt-5">
        <a href="{% url 'program_ideation:home' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle me-2"></i>
            {% if idea.language == 'ar' %}
            بدء فكرة جديدة
            {% else %}
            Start New Idea
            {% endif %}
        </a>
        <a href="{% url 'program_ideation:idea_list' %}" class="btn btn-outline-primary btn-lg">
            <i class="bi bi-list-ul me-2"></i>
            {% if idea.language == 'ar' %}
            أفكاري
            {% else %}
            My Ideas
            {% endif %}
        </a>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="floating-actions">
    <button class="fab" onclick="scrollToTop()">
        <i class="bi bi-arrow-up"></i>
    </button>
    <button class="fab primary" onclick="window.print()">
        <i class="bi bi-printer"></i>
    </button>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isRTL = document.documentElement.lang === 'ar' || 
                  document.querySelector('[dir="rtl"]') !== null;
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Smooth scroll to top
    window.scrollToTop = function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    };
    
    // Copy content function
    window.copyContent = function(section) {
        const content = document.getElementById(`${section}-content`);
        if (content) {
            const text = content.innerText;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(isRTL ? 'تم النسخ بنجاح!' : 'Copied successfully!');
                });
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast(isRTL ? 'تم النسخ بنجاح!' : 'Copied successfully!');
            }
        }
    };
    
    // Expand section in modal
    window.expandSection = function(section) {
        const content = document.getElementById(`${section}-content`);
        if (content) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${getSectionTitle(section)}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${content.innerHTML}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                ${isRTL ? 'إغلاق' : 'Close'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Clean up after close
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
    };
    
    function getSectionTitle(section) {
        const titles = {
            'questions': isRTL ? 'أسئلة النقاش' : 'Discussion Questions',
            'format': isRTL ? 'تنسيق البرنامج' : 'Program Format',
            'script': isRTL ? 'نص البرنامج' : 'Program Script',
            'visual': isRTL ? 'المواد البصرية' : 'Visual Materials'
        };
        return titles[section] || section;
    }
    
    // WORKING PDF Export using jsPDF
    window.exportToPDF = function() {
        showToast(isRTL ? 'جاري إعداد ملف PDF...' : 'Preparing PDF file...');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Get program data - properly escape quotes
        const programName = `{{ idea.program_name|default:"Program Idea"|escapejs }}`;
        const generalIdea = `{{ idea.general_idea|default:""|escapejs }}`;
        const targetAudience = `{{ idea.target_audience|default:""|escapejs }}`;
        const objectives = `{{ idea.program_objectives|default:""|escapejs }}`;
        const programType = `{{ idea.program_type|default:""|escapejs }}`;
        const duration = `{{ idea.program_duration|default:""|escapejs }}`;
        const episodes = `{{ idea.episode_count|default:""|escapejs }}`;
        const location = `{{ idea.filming_location|default:""|escapejs }}`;
        
        // Add content to PDF
        let yPosition = 20;
        
        // Title
        doc.setFontSize(20);
        doc.text(programName || 'Program Idea', 20, yPosition);
        yPosition += 15;
        
        // Add a line
        doc.setLineWidth(0.5);
        doc.line(20, yPosition, 190, yPosition);
        yPosition += 10;
        
        // Program Details
        doc.setFontSize(12);
        
        // Helper function to add text with word wrap
        function addSection(title, content) {
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text(title, 20, yPosition);
            yPosition += 7;
            
            doc.setFont(undefined, 'normal');
            if (content) {
                const lines = doc.splitTextToSize(content, 170);
                doc.text(lines, 20, yPosition);
                yPosition += lines.length * 5 + 8;
            } else {
                doc.text('N/A', 20, yPosition);
                yPosition += 13;
            }
        }
        
        // Add all sections
        addSection(isRTL ? 'الفكرة العامة:' : 'General Idea:', generalIdea);
        addSection(isRTL ? 'الجمهور المستهدف:' : 'Target Audience:', targetAudience);
        addSection(isRTL ? 'أهداف البرنامج:' : 'Program Objectives:', objectives);
        addSection(isRTL ? 'نوع البرنامج:' : 'Program Type:', programType);
        addSection(isRTL ? 'مدة البرنامج:' : 'Program Duration:', duration);
        addSection(isRTL ? 'عدد الحلقات:' : 'Episode Count:', episodes);
        addSection(isRTL ? 'موقع التصوير:' : 'Filming Location:', location);
        
        // Add generated content if available
        {% if responses.discussion_questions %}
        doc.addPage();
        yPosition = 20;
        doc.setFontSize(16);
        doc.text(isRTL ? 'أسئلة النقاش' : 'Discussion Questions', 20, yPosition);
        yPosition += 10;
        doc.setFontSize(11);
        const questions = `{{ responses.discussion_questions.content|escapejs }}`;
        const questionLines = doc.splitTextToSize(questions, 170);
        // Add only first 50 lines to avoid huge PDFs
        const maxLines = Math.min(questionLines.length, 50);
        for (let i = 0; i < maxLines; i++) {
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            doc.text(questionLines[i], 20, yPosition);
            yPosition += 5;
        }
        {% endif %}
        
        {% if responses.program_format %}
        doc.addPage();
        yPosition = 20;
        doc.setFontSize(16);
        doc.text(isRTL ? 'تنسيق البرنامج' : 'Program Format', 20, yPosition);
        yPosition += 10;
        doc.setFontSize(11);
        const format = `{{ responses.program_format.content|escapejs }}`;
        const formatLines = doc.splitTextToSize(format, 170);
        const maxFormatLines = Math.min(formatLines.length, 50);
        for (let i = 0; i < maxFormatLines; i++) {
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            doc.text(formatLines[i], 20, yPosition);
            yPosition += 5;
        }
        {% endif %}
        
        // Save the PDF
        const fileName = `${programName.replace(/[^a-z0-9]/gi, '_') || 'program'}_${new Date().getTime()}.pdf`;
        doc.save(fileName);
        
        showToast(isRTL ? 'تم تحميل ملف PDF بنجاح!' : 'PDF downloaded successfully!');
    };
    
    // WORKING Word Export (HTML to DOC)
    window.exportToWord = function() {
        showToast(isRTL ? 'جاري إعداد ملف Word...' : 'Preparing Word document...');
        
        // Get all the program data
        const programData = {
            name: `{{ idea.program_name|default:"Program Idea"|escapejs }}`,
            generalIdea: `{{ idea.general_idea|default:""|escapejs }}`,
            targetAudience: `{{ idea.target_audience|default:""|escapejs }}`,
            objectives: `{{ idea.program_objectives|default:""|escapejs }}`,
            type: `{{ idea.program_type|default:""|escapejs }}`,
            duration: `{{ idea.program_duration|default:""|escapejs }}`,
            episodes: `{{ idea.episode_count|default:""|escapejs }}`,
            location: `{{ idea.filming_location|default:""|escapejs }}`,
            createdAt: `{{ idea.created_at|date:"M d, Y"|escapejs }}`
        };
        
        // Prepare HTML content with Word-specific formatting
        let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                  xmlns:w='urn:schemas-microsoft-com:office:word' 
                  xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset="utf-8">
                <title>${programData.name}</title>
                <!--[if gte mso 9]>
                <xml>
                    <w:WordDocument>
                        <w:View>Print</w:View>
                        <w:Zoom>100</w:Zoom>
                        <w:DoNotOptimizeForBrowser/>
                    </w:WordDocument>
                </xml>
                <![endif]-->
                <style>
                    @page { 
                        size: A4;
                        margin: 2cm;
                    }
                    body { 
                        font-family: 'Calibri', Arial, sans-serif; 
                        font-size: 11pt;
                        line-height: 1.6;
                        color: #333;
                        ${isRTL ? 'direction: rtl; text-align: right;' : ''}
                    }
                    h1 { 
                        font-size: 24pt; 
                        color: #1a1a1a; 
                        border-bottom: 3px solid #667eea;
                        padding-bottom: 10px;
                        margin-bottom: 20px;
                    }
                    h2 { 
                        font-size: 18pt; 
                        color: #444; 
                        margin-top: 30px;
                        margin-bottom: 15px;
                        page-break-after: avoid;
                    }
                    h3 {
                        font-size: 14pt;
                        color: #666;
                        margin-top: 20px;
                        margin-bottom: 10px;
                    }
                    p { 
                        margin: 0 0 10pt 0; 
                    }
                    .meta-info {
                        background: #f5f5f5;
                        padding: 15px;
                        border-radius: 5px;
                        margin-bottom: 20px;
                    }
                    .section {
                        margin-bottom: 25px;
                        page-break-inside: avoid;
                    }
                    .label {
                        font-weight: bold;
                        color: #667eea;
                        display: inline-block;
                        min-width: 150px;
                    }
                    .content {
                        margin-left: 20px;
                        margin-top: 5px;
                    }
                    .page-break {
                        page-break-before: always;
                    }
                </style>
            </head>
            <body>
                <h1>${programData.name}</h1>
                
                <div class="meta-info">
                    <p><span class="label">${isRTL ? 'تاريخ الإنشاء:' : 'Created Date:'}</span> ${programData.createdAt}</p>
                    <p><span class="label">${isRTL ? 'نوع البرنامج:' : 'Program Type:'}</span> ${programData.type || 'N/A'}</p>
                    <p><span class="label">${isRTL ? 'المدة:' : 'Duration:'}</span> ${programData.duration || 'N/A'}</p>
                    <p><span class="label">${isRTL ? 'عدد الحلقات:' : 'Episodes:'}</span> ${programData.episodes || 'N/A'}</p>
                </div>
                
                <h2>${isRTL ? 'تفاصيل البرنامج' : 'Program Details'}</h2>
                
                <div class="section">
                    <h3>${isRTL ? 'الفكرة العامة' : 'General Idea'}</h3>
                    <div class="content">${programData.generalIdea || 'N/A'}</div>
                </div>
                
                <div class="section">
                    <h3>${isRTL ? 'الجمهور المستهدف' : 'Target Audience'}</h3>
                    <div class="content">${programData.targetAudience || 'N/A'}</div>
                </div>
                
                <div class="section">
                    <h3>${isRTL ? 'أهداف البرنامج' : 'Program Objectives'}</h3>
                    <div class="content">${programData.objectives || 'N/A'}</div>
                </div>
                
                <div class="section">
                    <h3>${isRTL ? 'موقع التصوير' : 'Filming Location'}</h3>
                    <div class="content">${programData.location || 'N/A'}</div>
                </div>
        `;
        
        // Add generated content
        {% if responses.discussion_questions %}
        htmlContent += `
            <div class="page-break"></div>
            <h2>${isRTL ? 'أسئلة النقاش' : 'Discussion Questions'}</h2>
            <div class="section">{{ responses.discussion_questions.content|escapejs|linebreaksbr }}</div>
        `;
        {% endif %}
        
        {% if responses.program_format %}
        htmlContent += `
            <div class="page-break"></div>
            <h2>${isRTL ? 'تنسيق البرنامج' : 'Program Format'}</h2>
            <div class="section">{{ responses.program_format.content|escapejs|linebreaksbr }}</div>
        `;
        {% endif %}
        
        {% if responses.program_script %}
        htmlContent += `
            <div class="page-break"></div>
            <h2>${isRTL ? 'نص البرنامج' : 'Program Script'}</h2>
            <div class="section">{{ responses.program_script.content|escapejs|linebreaksbr }}</div>
        `;
        {% endif %}
        
        {% if responses.visual_materials %}
        htmlContent += `
            <div class="page-break"></div>
            <h2>${isRTL ? 'المواد البصرية' : 'Visual Materials'}</h2>
            <div class="section">{{ responses.visual_materials.content|escapejs|linebreaksbr }}</div>
        `;
        {% endif %}
        
        htmlContent += `
            </body>
            </html>
        `;
        
        // Create blob and download
        const blob = new Blob(['\ufeff', htmlContent], {
            type: 'application/msword'
        });
        
        const fileName = `${programData.name.replace(/[^a-z0-9]/gi, '_') || 'program'}_${new Date().getTime()}.doc`;
        
        // Use FileSaver.js if available, otherwise use fallback
        if (window.saveAs) {
            window.saveAs(blob, fileName);
        } else {
            // Fallback method
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        showToast(isRTL ? 'تم تحميل ملف Word بنجاح!' : 'Word document downloaded successfully!');
    };
    
    // Share project
    window.shareProject = function() {
        if (navigator.share) {
            navigator.share({
                title: document.title,
                text: isRTL ? 'شاهد فكرة البرنامج' : 'Check out this program idea',
                url: window.location.href
            }).catch(err => console.log('Error sharing:', err));
        } else {
            // Fallback - copy link
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast(isRTL ? 'تم نسخ الرابط!' : 'Link copied!');
            });
        }
    };
    
    // Toast notification
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            animation: slideInUp 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOutDown 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
    
    // Add animation keyframes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Track tab changes
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
        button.addEventListener('shown.bs.tab', function (e) {
            console.log('Tab switched to:', e.target.id);
        });
    });
});
</script>
{% endblock %}
{% endblock %}