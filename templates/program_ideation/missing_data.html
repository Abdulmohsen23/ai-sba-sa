{% extends 'program_ideation/base.html' %}
{% load crispy_forms_tags %}

{% block ideation_title %}{{ title }}{% endblock %}

{% block ideation_content %}
<style>
    .ideation-container {
        display: flex;
        gap: 20px;
        padding: 20px;
    }
    
    .ideation-form-container {
        flex: 1;
        min-width: 400px;
    }
    
    .ideation-response-container {
        flex: 1;
        min-width: 400px;
    }
    
    .response-area {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        height: calc(100vh - 200px);
        overflow-y: auto;
    }
    
    .field-suggestions-section {
        margin-bottom: 25px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .field-suggestions-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .field-suggestions-header .badge {
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .suggestion-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .suggestion-item:hover {
        background: #f1f3f5;
    }
    
    .suggestion-number {
        display: inline-block;
        background: #6c757d;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        font-size: 12px;
        margin-right: 10px;
        font-weight: bold;
    }
    
    .suggestion-text {
        display: inline-block;
        flex: 1;
        color: #495057;
        line-height: 1.6;
    }
    
    .suggestion-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }
    
    .btn-apply-suggestion {
        padding: 6px 16px;
        font-size: 13px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-apply-primary {
        background: #28a745;
        color: white;
    }
    
    .btn-apply-primary:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    
    .btn-copy-suggestion {
        background: #6c757d;
        color: white;
    }
    
    .btn-copy-suggestion:hover {
        background: #5a6268;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
    }
    
    .applied-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: none;
    }
    
    .suggestion-item.applied .applied-indicator {
        display: block;
    }
    
    .suggestion-item.applied {
        background: #d4edda;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
    }
    
    .loading-spinner .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 9999;
        animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .field-group {
        margin-bottom: 20px;
    }
    
    /* RTL Support */
    [dir="rtl"] .suggestion-number {
        margin-right: 0;
        margin-left: 10px;
    }
    
    [dir="rtl"] .applied-indicator {
        right: auto;
        left: 10px;
    }
    
    [dir="rtl"] .toast-notification {
        right: auto;
        left: 20px;
    }
</style>

<div class="ideation-container">
    <div class="ideation-form-container">
        <div class="card shadow-sm">
            <div class="card-body p-4" {% if idea.language == 'ar' %}dir="rtl"{% endif %}>
                <h3 class="card-title mb-4">
                    {% if idea.language == 'ar' %}
                    تفاصيل عن الفكرة
                    {% else %}
                    Idea Details
                    {% endif %}
                </h3>
                
                <form method="post" id="ideaForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-12 field-group">
                            {{ form.program_name|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-12 field-group">
                            {{ form.general_idea|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-12 field-group">
                            {{ form.target_audience|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-12 field-group">
                            {{ form.program_objectives|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6 field-group">
                            {{ form.program_type|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6 field-group">
                            {{ form.program_duration|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6 field-group">
                            {{ form.episode_count|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6 field-group">
                            {{ form.filming_location|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check2-circle me-2"></i>
                            {% if idea.language == 'ar' %}
                            حفظ وتقييم
                            {% else %}
                            Save and Evaluate
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="ideation-response-container">
        <div class="response-area">
            <h3 class="text-center mb-4">
                {% if idea.language == 'ar' %}
                <i class="bi bi-lightbulb"></i> اقتراحات للبيانات الناقصة
                {% else %}
                <i class="bi bi-lightbulb"></i> Suggestions for Missing Data
                {% endif %}
            </h3>
            
            <div id="suggestions-container">
                {% if response %}
                    <div id="response-content" style="display:none;">{{ response.content }}</div>
                {% else %}
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">
                            {% if idea.language == 'ar' %}
                            جاري إعداد المقترحات...
                            {% else %}
                            Preparing suggestions...
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-notification" class="toast-notification">
    <i class="bi bi-check-circle-fill"></i>
    <span id="toast-message"></span>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isRTL = document.documentElement.lang === 'ar' || 
                  document.querySelector('[dir="rtl"]') !== null;
    
    // Field mapping for both languages
     // Fix the field mapping to ensure program_name is recognized
const fieldMapping = {
    'اسم البرنامج': 'program_name',
    'الفكرة العامة': 'general_idea',
    'الجمهور المستهدف': 'target_audience',
    'أهداف البرنامج': 'program_objectives',
    'نوع البرنامج': 'program_type',
    'مدة البرنامج': 'program_duration',
    'عدد الحلقات': 'episode_count',
    'موقع أو أسلوب التصوير': 'filming_location',
    'موقع التصوير': 'filming_location',
    // English mappings
    'Program Name': 'program_name',
    'General Idea': 'general_idea',
    'Target Audience': 'target_audience',
    'Program Objectives': 'program_objectives',
    'Program Type': 'program_type',
    'Program Duration': 'program_duration',
    'Episode Count': 'episode_count',
    'Filming Location': 'filming_location'
};
    
    // Initialize suggestions
    initializeSuggestions();
    
    function initializeSuggestions() {
        const responseContent = document.getElementById('response-content');
        if (responseContent) {
            const content = responseContent.textContent || responseContent.innerText;
            if (content && content.trim()) {
                parseSuggestions(content);
            }
        }
    }
    
    function parseSuggestions(content) {
        const container = document.getElementById('suggestions-container');
        container.innerHTML = '';
        
        // Parse sections using regex
        const sectionRegex = /={3,}\s*([^=]+?)\s*={3,}([\s\S]*?)(?=={3,}|$)/g;
        let match;
        const sections = [];
        
        while ((match = sectionRegex.exec(content)) !== null) {
            const fieldName = match[1].trim();
            const fieldContent = match[2].trim();
            
            if (fieldName && fieldContent) {
                sections.push({
                    fieldName: fieldName,
                    content: fieldContent,
                    fieldId: fieldMapping[fieldName] || 'unknown'
                });
            }
        }
        
        if (sections.length === 0) {
            // Try alternative parsing for unstructured content
            parseUnstructuredContent(content, container);
            return;
        }
        
        // Create UI for each section
        sections.forEach(section => {
            createSuggestionSection(section, container);
        });
    }
    
    function parseUnstructuredContent(content, container) {
        // Try to extract suggestions even without proper formatting
        const lines = content.split('\n').filter(line => line.trim());
        
        const section = {
            fieldName: isRTL ? 'اقتراحات عامة' : 'General Suggestions',
            content: lines.join('\n'),
            fieldId: 'general'
        };
        
        createSuggestionSection(section, container);
    }
    
    function createSuggestionSection(section, container) {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'field-suggestions-section';
        sectionDiv.dataset.fieldId = section.fieldId;
        
        // Create header
        const header = document.createElement('div');
        header.className = 'field-suggestions-header';
        header.innerHTML = `
            <span>${section.fieldName}</span>
            <span class="badge">Field: ${section.fieldId}</span>
        `;
        sectionDiv.appendChild(header);
        
        // Parse individual suggestions
        const suggestions = extractSuggestions(section.content);
        
        // Create suggestion items
        suggestions.forEach((suggestion, index) => {
            const suggestionItem = createSuggestionItem(suggestion, index + 1, section.fieldId);
            sectionDiv.appendChild(suggestionItem);
        });
        
        container.appendChild(sectionDiv);
    }
    
    function extractSuggestions(content) {
        const suggestions = [];
        const lines = content.split('\n').filter(line => line.trim());
        
        // Patterns to identify suggestions
        const patterns = [
            /^(اقتراح|Suggestion)\s*\d+\s*:\s*(.+)/i,
            /^\d+\.\s*(.+)/,
            /^[-•*]\s*(.+)/,
            /\*\*(اقتراح|Suggestion)\s*\d+\*\*\s*:\s*(.+)/i
        ];
        
        let currentSuggestion = '';
        
        for (const line of lines) {
            let matched = false;
            
            for (const pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    if (currentSuggestion) {
                        suggestions.push(currentSuggestion.trim());
                    }
                    currentSuggestion = match[match.length - 1];
                    matched = true;
                    break;
                }
            }
            
            if (!matched) {
                if (currentSuggestion) {
                    currentSuggestion += ' ' + line;
                } else if (line.trim()) {
                    currentSuggestion = line;
                }
            }
        }
        
        if (currentSuggestion) {
            suggestions.push(currentSuggestion.trim());
        }
        
        // If no suggestions found, treat the whole content as one suggestion
        if (suggestions.length === 0 && content.trim()) {
            suggestions.push(content.trim());
        }
        
        return suggestions;
    }
    
    function createSuggestionItem(text, number, fieldId) {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.dataset.fieldId = fieldId;
    div.dataset.suggestionText = text;
    div.dataset.suggestionNumber = number;
    
    const content = document.createElement('div');
    content.innerHTML = `
        <span class="suggestion-number">${number}</span>
        <span class="suggestion-text">${text}</span>
    `;
    div.appendChild(content);
    
    const actions = document.createElement('div');
    actions.className = 'suggestion-actions';
    
    // Create apply button without inline onclick
    const applyBtn = document.createElement('button');
    applyBtn.type = 'button';
    applyBtn.className = 'btn-apply-suggestion btn-apply-primary';
    applyBtn.innerHTML = `<i class="bi bi-check2"></i> ${isRTL ? 'تطبيق' : 'Apply'}`;
    
    // Add event listener instead of onclick attribute
    applyBtn.addEventListener('click', function() {
        applySuggestion(fieldId, text, this);
    });
    
    // Create copy button
    const copyBtn = document.createElement('button');
    copyBtn.type = 'button';
    copyBtn.className = 'btn-apply-suggestion btn-copy-suggestion';
    copyBtn.innerHTML = `<i class="bi bi-clipboard"></i> ${isRTL ? 'نسخ' : 'Copy'}`;
    
    // Add event listener for copy
    copyBtn.addEventListener('click', function() {
        copySuggestion(text);
    });
    
    actions.appendChild(applyBtn);
    actions.appendChild(copyBtn);
    div.appendChild(actions);
    
    const indicator = document.createElement('div');
    indicator.className = 'applied-indicator';
    indicator.innerHTML = '<i class="bi bi-check"></i> ' + (isRTL ? 'مطبق' : 'Applied');
    div.appendChild(indicator);
    
    return div;
}
    
    // Global functions for button clicks
   // Also update the applySuggestion function to handle the field ID correctly:
window.applySuggestion = function(fieldId, text, button) {
    // For templates without AJAX (suggestions.html, missing_data.html)
    const field = document.getElementById(`id_${fieldId}`);
    
    if (field) {
        // Apply the suggestion
        field.value = text;
        
        // Visual feedback
        field.style.transition = 'all 0.3s ease';
        field.style.backgroundColor = '#d4edda';
        field.style.border = '2px solid #28a745';
        
        setTimeout(() => {
            field.style.backgroundColor = '';
            field.style.border = '';
        }, 2000);
        
        // Mark as applied
        const suggestionItem = button.closest('.suggestion-item');
        if (suggestionItem) {
            suggestionItem.classList.add('applied');
        }
        
        showToast(isRTL ? 'تم تطبيق الاقتراح بنجاح!' : 'Suggestion applied successfully!');
        
        // Scroll to field
        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        field.focus();
    } else {
        console.error('Field not found:', `id_${fieldId}`);
        showToast(isRTL ? 'لم يتم العثور على الحقل' : 'Field not found', 'error');
    }
};
    
    window.copySuggestion = function(button) {
        const suggestionItem = button.closest('.suggestion-item');
        const text = suggestionItem.dataset.suggestionText;
        
        // Copy to clipboard
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(isRTL ? 'تم نسخ الاقتراح!' : 'Suggestion copied!');
            }).catch(() => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    };
    
    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast(isRTL ? 'تم نسخ الاقتراح!' : 'Suggestion copied!');
    }
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        const messageEl = document.getElementById('toast-message');
        
        messageEl.textContent = message;
        toast.style.background = type === 'success' ? '#28a745' : '#dc3545';
        toast.style.display = 'flex';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
    
    // Auto-save functionality
    let autoSaveTimeout;
    const formFields = document.querySelectorAll('#ideaForm input, #ideaForm textarea, #ideaForm select');
    
    formFields.forEach(field => {
        field.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                // You can implement auto-save here if needed
                console.log('Auto-save triggered for field:', field.name);
            }, 2000);
        });
    });
    
    // Polling for processing status (if needed)
    {% if note and note.status == 'processing' %}
    const pollingInterval = setInterval(() => {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.getElementById('response-content');
                
                if (newContent && newContent.textContent.trim()) {
                    clearInterval(pollingInterval);
                    parseSuggestions(newContent.textContent);
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
                clearInterval(pollingInterval);
            });
    }, 5000);
    {% endif %}
});
</script>
{% endblock %}
{% endblock %}