{% extends 'program_ideation/base.html' %}

{% block ideation_title %}{{ title }}{% endblock %}

{% block tool_actions %}
<a href="{% url 'program_ideation:note_list' idea_id=idea.id %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i>
    {% if idea.language == 'ar' %}
    العودة للملاحظات
    {% else %}
    Back to Notes
    {% endif %}
</a>
{% endblock %}

{% block ideation_content %}
<style>
    .note-detail-container {
        display: flex;
        gap: 20px;
        padding: 20px;
    }
    
    .note-info-section {
        flex: 0 0 350px;
    }
    
    .suggestions-section {
        flex: 1;
        min-width: 0;
    }
    
    .field-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        border-left: 4px solid #6c757d;
    }
    
    [dir="rtl"] .field-item {
        border-left: none;
        border-right: 4px solid #6c757d;
    }
    
    .field-label {
        font-weight: 600;
        color: #495057;
        font-size: 13px;
        text-transform: uppercase;
        margin-bottom: 5px;
        opacity: 0.8;
    }
    
    .field-content {
        color: #212529;
        line-height: 1.6;
    }
    
    .field-content.empty {
        color: #6c757d;
        font-style: italic;
    }
    
    .note-content-card {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
    }
    
    .note-meta {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #6c757d;
        font-size: 13px;
        margin-top: 10px;
    }
    
    .field-suggestions-section {
        margin-bottom: 25px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .field-suggestions-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .field-suggestions-header .badge {
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .suggestion-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        min-height: 60px;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .suggestion-item:hover {
        background: #f1f3f5;
    }
    
    .suggestion-number {
        display: inline-block;
        background: #6c757d;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        font-size: 12px;
        margin-right: 10px;
        font-weight: bold;
    }
    
    [dir="rtl"] .suggestion-number {
        margin-right: 0;
        margin-left: 10px;
    }
    
    .suggestion-text {
        display: inline-block;
        flex: 1;
        color: #495057;
        line-height: 1.6;
        padding-right: 150px;
    }
    
    [dir="rtl"] .suggestion-text {
        padding-right: 0;
        padding-left: 150px;
    }
    
    .suggestion-actions {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 8px;
    }
    
    [dir="rtl"] .suggestion-actions {
        right: auto;
        left: 20px;
    }
    
    .btn-apply-suggestion {
        padding: 6px 16px;
        font-size: 13px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-apply-primary {
        background: #28a745;
        color: white;
    }
    
    .btn-apply-primary:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    
    .btn-copy-suggestion {
        background: #6c757d;
        color: white;
    }
    
    .btn-copy-suggestion:hover {
        background: #5a6268;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
    }
    
    .applied-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: none;
    }
    
    [dir="rtl"] .applied-indicator {
        right: auto;
        left: 10px;
    }
    
    .suggestion-item.applied .applied-indicator {
        display: block;
    }
    
    .suggestion-item.applied {
        background: #d4edda;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
    }
    
    .loading-spinner .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }
    
    .status-badge.completed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.processing {
        background: #cce5ff;
        color: #004085;
    }
    
    .status-badge.failed {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-badge.pending {
        background: #e2e3e5;
        color: #383d41;
    }
    
    .quick-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .quick-actions-header {
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quick-action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn-quick-action {
        padding: 8px 16px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .btn-quick-action:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-1px);
    }
    
    .btn-quick-action.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 9999;
        animation: slideInUp 0.3s ease;
    }
    
    [dir="rtl"] .toast-notification {
        right: auto;
        left: 20px;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @media (max-width: 768px) {
        .note-detail-container {
            flex-direction: column;
        }
        
        .note-info-section {
            flex: 1;
        }
    }
</style>

<div class="note-detail-container" {% if idea.language == 'ar' %}dir="rtl"{% endif %}>
    <!-- Left Section: Note Information -->
    <div class="note-info-section">
        <!-- Fields Information -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-file-text"></i>
                    {% if idea.language == 'ar' %}
                    الحقول المرتبطة
                    {% else %}
                    Related Fields
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% for field in note.fields.all %}
                <div class="field-item">
                    <div class="field-label">
                        {% if idea.language == 'ar' %}
                        {{ field.get_field_label_arabic }}
                        {% else %}
                        {{ field.get_field_name_display }}
                        {% endif %}
                    </div>
                    <div class="field-content {% if not field.current_content %}empty{% endif %}">
                        {{ field.current_content|default:"(Empty)" }}
                    </div>
                </div>
                {% empty %}
                <!-- Fallback for single field (backward compatibility) -->
                <div class="field-item">
                    <div class="field-label">
                        {% if idea.language == 'ar' %}
                        {{ note.get_field_label_arabic }}
                        {% else %}
                        {{ note.get_field_name_display }}
                        {% endif %}
                    </div>
                    <div class="field-content {% if not field_content %}empty{% endif %}">
                        {{ field_content|default:"(Empty)" }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- User's Note -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-chat-left-text"></i>
                    {% if idea.language == 'ar' %}
                    ملاحظتك
                    {% else %}
                    Your Note
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="note-content-card">
                    <p class="mb-0">{{ note.note_content }}</p>
                </div>
                <div class="note-meta">
                    <i class="bi bi-clock"></i>
                    <span>{{ note.created_at|date:"M d, Y h:i A" }}</span>
                    <span class="status-badge {{ note.status }}">
                        {% if note.status == 'completed' %}
                            <i class="bi bi-check-circle"></i>
                            {% if idea.language == 'ar' %}مكتمل{% else %}Completed{% endif %}
                        {% elif note.status == 'processing' %}
                            <i class="bi bi-hourglass-split"></i>
                            {% if idea.language == 'ar' %}قيد المعالجة{% else %}Processing{% endif %}
                        {% elif note.status == 'failed' %}
                            <i class="bi bi-x-circle"></i>
                            {% if idea.language == 'ar' %}فشل{% else %}Failed{% endif %}
                        {% else %}
                            <i class="bi bi-clock"></i>
                            {% if idea.language == 'ar' %}قيد الانتظار{% else %}Pending{% endif %}
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Section: AI Suggestions -->
    <div class="suggestions-section">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i>
                    {% if idea.language == 'ar' %}
                    اقتراحات التحسين
                    {% else %}
                    Enhancement Suggestions
                    {% endif %}
                </h5>
                {% if not note.is_applied %}
                <button type="button" class="btn btn-sm btn-outline-primary" id="applyAllBtn" style="display:none;">
                    <i class="bi bi-check-all"></i>
                    {% if idea.language == 'ar' %}
                    تطبيق الكل
                    {% else %}
                    Apply All
                    {% endif %}
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if note.status == 'completed' and note.response_content %}
                    <!-- Quick Actions -->
                    {% if not note.is_applied %}
                    <div class="quick-actions">
                        <div class="quick-actions-header">
                            <i class="bi bi-lightning-fill text-warning"></i>
                            <span>
                                {% if idea.language == 'ar' %}
                                إجراءات سريعة
                                {% else %}
                                Quick Actions
                                {% endif %}
                            </span>
                        </div>
                        <div class="quick-action-buttons">
                            <button type="button" class="btn-quick-action" onclick="applyFirstSuggestion()">
                                {% if idea.language == 'ar' %}
                                تطبيق الاقتراح الأول
                                {% else %}
                                Apply First Suggestion
                                {% endif %}
                            </button>
                            <button type="button" class="btn-quick-action" onclick="copyAllSuggestions()">
                                {% if idea.language == 'ar' %}
                                نسخ جميع الاقتراحات
                                {% else %}
                                Copy All Suggestions
                                {% endif %}
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Suggestions Container -->
                    <div id="suggestions-container">
                        <div id="response-content" style="display:none;">{{ note.response_content }}</div>
                    </div>
                    
                {% elif note.status == 'processing' %}
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">
                            {% if idea.language == 'ar' %}
                            جاري معالجة ملاحظتك...
                            {% else %}
                            Processing your note...
                            {% endif %}
                        </p>
                    </div>
                {% elif note.status == 'failed' %}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        {% if idea.language == 'ar' %}
                        حدث خطأ أثناء معالجة ملاحظتك. يرجى المحاولة مرة أخرى.
                        {% else %}
                        An error occurred while processing your note. Please try again.
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-primary" onclick="retryProcessing()">
                        <i class="bi bi-arrow-clockwise"></i>
                        {% if idea.language == 'ar' %}
                        إعادة المحاولة
                        {% else %}
                        Retry
                        {% endif %}
                    </button>
                {% else %}
                    <div class="text-center p-5">
                        <i class="bi bi-hourglass-split text-secondary" style="font-size: 48px;"></i>
                        <p class="mt-3">
                            {% if idea.language == 'ar' %}
                            ملاحظتك في قائمة الانتظار للمعالجة...
                            {% else %}
                            Your note is queued for processing...
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-notification" class="toast-notification">
    <i class="bi bi-check-circle-fill"></i>
    <span id="toast-message"></span>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isRTL = document.documentElement.lang === 'ar' || 
                  document.querySelector('[dir="rtl"]') !== null;
    
    // Fix the field mapping to ensure program_name is recognized
const fieldMapping = {
    'اسم البرنامج': 'program_name',
    'الفكرة العامة': 'general_idea',
    'الجمهور المستهدف': 'target_audience',
    'أهداف البرنامج': 'program_objectives',
    'نوع البرنامج': 'program_type',
    'مدة البرنامج': 'program_duration',
    'عدد الحلقات': 'episode_count',
    'موقع أو أسلوب التصوير': 'filming_location',
    'موقع التصوير': 'filming_location',
    // English mappings
    'Program Name': 'program_name',
    'General Idea': 'general_idea',
    'Target Audience': 'target_audience',
    'Program Objectives': 'program_objectives',
    'Program Type': 'program_type',
    'Program Duration': 'program_duration',
    'Episode Count': 'episode_count',
    'Filming Location': 'filming_location'
};
    let allSuggestions = {};
    
    // Initialize suggestions if content is available
    {% if note.status == 'completed' and note.response_content %}
    initializeSuggestions();
    {% endif %}
    
    function initializeSuggestions() {
        const responseContent = document.getElementById('response-content');
        if (responseContent) {
            const content = responseContent.textContent || responseContent.innerText;
            if (content && content.trim()) {
                parseSuggestions(content);
            }
        }
    }
    
    function parseSuggestions(content) {
        const container = document.getElementById('suggestions-container');
        container.innerHTML = '';
        
        // Parse sections using regex
        const sectionRegex = /={3,}\s*([^=]+?)\s*={3,}([\s\S]*?)(?=={3,}|$)/g;
        let match;
        const sections = [];
        
        while ((match = sectionRegex.exec(content)) !== null) {
            const fieldName = match[1].trim();
            const fieldContent = match[2].trim();
            
            if (fieldName && fieldContent) {
                sections.push({
                    fieldName: fieldName,
                    content: fieldContent,
                    fieldId: fieldMapping[fieldName] || detectFieldType(fieldName)
                });
            }
        }
        
        // If no structured sections, try unstructured parsing
        if (sections.length === 0) {
            parseUnstructuredContent(content, container);
        } else {
            // Create UI for each section
            sections.forEach(section => {
                createSuggestionSection(section, container);
            });
            
            // Show apply all button if we have suggestions
            if (Object.keys(allSuggestions).length > 0) {
                document.getElementById('applyAllBtn').style.display = 'block';
            }
        }
    }
    
    function parseUnstructuredContent(content, container) {
        // Create a general suggestions section
        const section = {
            fieldName: isRTL ? 'اقتراحات عامة' : 'General Suggestions',
            content: content,
            fieldId: 'general'
        };
        createSuggestionSection(section, container);
    }
    
    function detectFieldType(fieldName) {
        const nameLC = fieldName.toLowerCase();
        
        if (nameLC.includes('name') || nameLC.includes('اسم')) return 'program_name';
        if (nameLC.includes('idea') || nameLC.includes('فكرة')) return 'general_idea';
        if (nameLC.includes('audience') || nameLC.includes('جمهور')) return 'target_audience';
        if (nameLC.includes('objective') || nameLC.includes('أهداف')) return 'program_objectives';
        if (nameLC.includes('type') || nameLC.includes('نوع')) return 'program_type';
        if (nameLC.includes('duration') || nameLC.includes('مدة')) return 'program_duration';
        if (nameLC.includes('episode') || nameLC.includes('حلقات')) return 'episode_count';
        if (nameLC.includes('location') || nameLC.includes('موقع')) return 'filming_location';
        
        return 'general';
    }
    
    function createSuggestionSection(section, container) {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'field-suggestions-section';
        sectionDiv.dataset.fieldId = section.fieldId;
        
        // Create header
        const header = document.createElement('div');
        header.className = 'field-suggestions-header';
        header.innerHTML = `
            <span>${section.fieldName}</span>
            <span class="badge">${section.fieldId}</span>
        `;
        sectionDiv.appendChild(header);
        
        // Parse individual suggestions
        const suggestions = extractSuggestions(section.content);
        
        // Store suggestions
        if (suggestions.length > 0) {
            allSuggestions[section.fieldId] = suggestions;
        }
        
        // Create suggestion items
        suggestions.forEach((suggestion, index) => {
            const suggestionItem = createSuggestionItem(suggestion, index + 1, section.fieldId);
            sectionDiv.appendChild(suggestionItem);
        });
        
        container.appendChild(sectionDiv);
    }
    
    function extractSuggestions(content) {
        const suggestions = [];
        const lines = content.split('\n').filter(line => line.trim());
        
        const patterns = [
            /^(اقتراح|Suggestion)\s*\d+\s*:\s*(.+)/i,
            /^\d+\.\s*(.+)/,
            /^[-•*]\s*(.+)/
        ];
        
        let currentSuggestion = '';
        
        for (const line of lines) {
            let matched = false;
            
            for (const pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    if (currentSuggestion) {
                        suggestions.push(currentSuggestion.trim());
                    }
                    currentSuggestion = match[match.length - 1];
                    matched = true;
                    break;
                }
            }
            
            if (!matched) {
                if (currentSuggestion) {
                    currentSuggestion += ' ' + line;
                } else if (line.trim()) {
                    currentSuggestion = line;
                }
            }
        }
        
        if (currentSuggestion) {
            suggestions.push(currentSuggestion.trim());
        }
        
        return suggestions.length > 0 ? suggestions : [content.trim()];
    }
    
        function createSuggestionItem(text, number, fieldId) {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.dataset.fieldId = fieldId;
        div.dataset.suggestionText = text;
        div.dataset.suggestionNumber = number;
        
        const content = document.createElement('div');
        content.innerHTML = `
            <span class="suggestion-number">${number}</span>
            <span class="suggestion-text">${text}</span>
        `;
        div.appendChild(content);
        
        const actions = document.createElement('div');
        actions.className = 'suggestion-actions';
        
        // Create apply button without inline onclick
        const applyBtn = document.createElement('button');
        applyBtn.type = 'button';
        applyBtn.className = 'btn-apply-suggestion btn-apply-primary';
        applyBtn.innerHTML = `<i class="bi bi-check2"></i> ${isRTL ? 'تطبيق' : 'Apply'}`;
        
        // Add event listener instead of onclick attribute
        applyBtn.addEventListener('click', function() {
            applySuggestion(fieldId, text, this);
        });
        
        // Create copy button
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'btn-apply-suggestion btn-copy-suggestion';
        copyBtn.innerHTML = `<i class="bi bi-clipboard"></i> ${isRTL ? 'نسخ' : 'Copy'}`;
        
        // Add event listener for copy
        copyBtn.addEventListener('click', function() {
            copySuggestion(text);
        });
        
        actions.appendChild(applyBtn);
        actions.appendChild(copyBtn);
        div.appendChild(actions);
        
        const indicator = document.createElement('div');
        indicator.className = 'applied-indicator';
        indicator.innerHTML = '<i class="bi bi-check"></i> ' + (isRTL ? 'مطبق' : 'Applied');
        div.appendChild(indicator);
        
        return div;
    }
    
    // Global functions
    window.applySuggestion = function(fieldId, text, button) {
        // Send AJAX request to apply suggestion
        fetch('{% url "program_ideation:apply_note_suggestion" note.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                field_id: fieldId,
                suggestion_text: text
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mark as applied
                const suggestionItem = button.closest('.suggestion-item');
                if (suggestionItem) {
                    suggestionItem.classList.add('applied');
                }
                showToast(isRTL ? 'تم تطبيق الاقتراح بنجاح!' : 'Suggestion applied successfully!');
            } else {
                showToast(data.message || (isRTL ? 'حدث خطأ' : 'An error occurred'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(isRTL ? 'حدث خطأ في الاتصال' : 'Connection error', 'error');
        });
    };
    
    window.copySuggestion = function(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(isRTL ? 'تم نسخ الاقتراح!' : 'Suggestion copied!');
            }).catch(() => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    };
    
    window.applyFirstSuggestion = function() {
        const firstButton = document.querySelector('.btn-apply-primary');
        if (firstButton) {
            firstButton.click();
        }
    };
    
    window.copyAllSuggestions = function() {
        let allText = '';
        Object.entries(allSuggestions).forEach(([fieldId, suggestions]) => {
            allText += `\n${fieldId}:\n`;
            suggestions.forEach((suggestion, index) => {
                allText += `${index + 1}. ${suggestion}\n`;
            });
        });
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(allText).then(() => {
                showToast(isRTL ? 'تم نسخ جميع الاقتراحات!' : 'All suggestions copied!');
            });
        }
    };
    
    window.retryProcessing = function() {
        window.location.reload();
    };
    
    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast(isRTL ? 'تم نسخ الاقتراح!' : 'Suggestion copied!');
    }
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        const messageEl = document.getElementById('toast-message');
        
        messageEl.textContent = message;
        toast.style.background = type === 'success' ? '#28a745' : '#dc3545';
        toast.style.display = 'flex';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
    
    // Apply all suggestions
    document.getElementById('applyAllBtn')?.addEventListener('click', function() {
        const buttons = document.querySelectorAll('.btn-apply-primary:not(.applied .btn-apply-primary)');
        buttons.forEach((button, index) => {
            setTimeout(() => {
                button.click();
            }, index * 500); // Stagger the applications
        });
    });
    
    // Polling for processing status
    {% if note.status == 'processing' %}
    const pollingInterval = setInterval(() => {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.getElementById('response-content');
                
                if (newContent && newContent.textContent.trim()) {
                    clearInterval(pollingInterval);
                    parseSuggestions(newContent.textContent);
                    showToast(isRTL ? 'تم إكمال المعالجة!' : 'Processing complete!');
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
                clearInterval(pollingInterval);
            });
    }, 3000);
    
    window.addEventListener('beforeunload', () => {
        clearInterval(pollingInterval);
    });
    {% endif %}
});
</script>
{% endblock %}
{% endblock %}